<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  <style>
    html, body, #map {
      width: 100%; height: 100%; margin: 0; padding: 0;
      background-color: #1a1a2e;
    }
    .leaflet-popup-content-wrapper {
      background-color: #16213e;
      color: #fff;
      border: 1px solid #0f3460;
    }
    .leaflet-popup-tip {
      background-color: #16213e;
    }
    .leaflet-container {
        background: #1a1a2e;
    }
    #error-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #e94560;
        color: white;
        padding: 20px;
        border-radius: 10px;
        font-family: sans-serif;
        display: none;
        z-index: 10000;
    }
  </style>
</head>
<body>
  <div id="error-message"></div>
  <div id="map"></div>
  <script>
    // Initialize Leaflet Map
    var map;
    var markersLayer;
    var osmb;
    var darkTiles;
    var lightTiles;
    var satelliteTiles;

    try {
        if (typeof L === 'undefined') {
            var msg = "Leaflet (L) is not defined. Check internet connection or CDN URLs.";
            console.error(msg);
            document.body.innerHTML = "<h2 style='color:white; text-align:center; padding-top:20px;'>" + msg + "</h2>";
            throw new Error(msg);
        }

        map = L.map('map').setView([40.7128, -74.0060], 16); // NYC default
        console.log("Map initialized");

        // Marker Layer Group for easy clearing
        markersLayer = L.layerGroup().addTo(map);
        console.log("Markers layer initialized");

        // Tile Layers
        darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap &copy; CARTO',
          subdomains: 'abcd',
          maxZoom: 20
        });

        lightTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap &copy; CARTO',
          subdomains: 'abcd',
          maxZoom: 20
        });
        
        // Satellite Layer (Esri World Imagery)
        satelliteTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        });

        // Add default layer (Light)
        lightTiles.addTo(map);

        // Add 2.5D Buildings
        if (typeof OSMBuildings !== 'undefined') {
            osmb = new OSMBuildings(map).load('https://{s}.data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json');
            // Default Style (Light Mode)
            osmb.style({ color: '#666666', roofColor: '#aaaaaa' });
        } else {
            console.warn("OSMBuildings not loaded");
        }
    } catch (e) {
        console.error("Error initializing map: " + e);
        document.body.innerHTML = "<h2 style='color:red; text-align:center; padding-top:20px;'>Error initializing map: " + e + "</h2>";
    }

    function setTheme(theme) {
        if (!map) return;
        
        // If satellite is active, we don't switch base tiles yet, but we update the "underlying" preference if needed
        // For simplicity, theme toggle overrides everything to that theme.
        
        if (theme === 'dark') {
            if (map.hasLayer(lightTiles)) map.removeLayer(lightTiles);
            if (map.hasLayer(satelliteTiles)) map.removeLayer(satelliteTiles);
            
            darkTiles.addTo(map);
            document.getElementById('map').style.backgroundColor = '#1a1a2e';
            if (osmb) osmb.style({ color: 'rgb(233, 69, 96)', roofColor: 'rgb(233, 69, 96)' });
        } else {
            if (map.hasLayer(darkTiles)) map.removeLayer(darkTiles);
            if (map.hasLayer(satelliteTiles)) map.removeLayer(satelliteTiles);
            
            lightTiles.addTo(map);
            document.getElementById('map').style.backgroundColor = '#ffffff';
            if (osmb) osmb.style({ color: '#666666', roofColor: '#aaaaaa' });
        }
    }
    
    function setSatellite(enabled) {
        if (!map) return;
        
        if (enabled) {
            if (map.hasLayer(lightTiles)) map.removeLayer(lightTiles);
            if (map.hasLayer(darkTiles)) map.removeLayer(darkTiles);
            
            satelliteTiles.addTo(map);
            // Hide buildings in satellite mode as they look weird on top of photos usually
             if (osmb) osmb.hide();
        } else {
            // Revert to default (assume Light for now, or check UI state? Simplest is revert to light or dark)
            // Ideally we track current theme. For now, revert to Light as default behavior or let user toggle.
            // Let's revert to Light.
            map.removeLayer(satelliteTiles);
            lightTiles.addTo(map);
            if (osmb) {
                osmb.show();
                osmb.style({ color: '#666666', roofColor: '#aaaaaa' });
            }
        }
    }
    
    // Java Connector Bridge
    var javaConnector = {
        openNoteDetail: function(noteId) { console.log("Open Note: " + noteId); },
        onMapClicked: function(lat, lng) { console.log("Map Clicked: " + lat + ", " + lng); }
    };

    // Add Note Mode Flag
    var isAddNoteMode = false;

    function setAddNoteMode(enabled) {
        isAddNoteMode = enabled;
        if (enabled) {
            document.getElementById('map').style.cursor = 'crosshair';
        } else {
            document.getElementById('map').style.cursor = 'grab';
        }
    }

    // Map Click Event
    if (map) {
        map.on('click', function(e) {
            console.log("Map clicked at " + e.latlng);
            if (isAddNoteMode) {
                console.log("Add Note Mode Active. Calling JavaConnector.");
                // Call Java to open Compose Window
                if (window.javaConnector) {
                    window.javaConnector.onMapClicked(e.latlng.lat, e.latlng.lng);
                } else {
                    console.error("JavaConnector not found on map click!");
                }
            }
        });
    }

    // Function to add notes with custom floating markers
    function addNotes(notesJson, shouldFitBounds) {
      try {
        console.log("addNotes called with count: " + (notesJson ? JSON.parse(notesJson).length : 0) + ", fitBounds: " + shouldFitBounds);
        const notes = JSON.parse(notesJson);
        var bounds = [];

        // Clear existing markers
        if (markersLayer) {
            markersLayer.clearLayers();
        } else {
             if (map) markersLayer = L.layerGroup().addTo(map);
        }

        notes.forEach(note => {
          if (note.lat && note.lng) {
            
            // Android-like Vibrant Colors
            var colors = [
                '#6C5CE7', '#74B9FF', '#00B894', '#FF6B6B', 
                '#FDCB6E', '#E17055', '#A29BFE', '#55EFC4', 
                '#FF7675', '#FD79A8', '#00CEC9', '#81ECEC'
            ];
            var hash = 0;
            var str = note.id + (note.content || "");
            for (var i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            var colorIndex = Math.abs(hash) % colors.length;
            var randomColor = colors[colorIndex];
            
            var shortText = note.content ? (note.content.length > 20 ? note.content.substring(0, 20) + "..." : note.content) : "New Note";

            var htmlContent = "<div style='display: flex; flex-direction: column; align-items: center;'>";
            htmlContent += "<div style='background-color: " + randomColor + "; padding: 12px 12px 8px 12px; border-radius: 16px; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 4px 6px rgba(0,0,0,0.2); color: white; font-weight: bold; font-family: sans-serif; white-space: nowrap; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); margin-top: 0px;'>";
            htmlContent += "<span>" + shortText + "</span></div>";
            htmlContent += "</div>";

            var customIcon = L.divIcon({
                className: 'custom-div-icon',
                html: htmlContent,
                iconSize: [null, null], // Auto size
                iconAnchor: [20, 40]
            });

            var marker = L.marker([note.lat, note.lng], {icon: customIcon});
            marker.addTo(markersLayer);
            marker.noteId = note.id;

            marker.on('click', function(e) {
                console.log("Marker clicked: " + this.noteId);
                if (window.javaConnector) {
                    window.javaConnector.openNoteDetail(this.noteId);
                }
                L.DomEvent.stopPropagation(e); 
            });
            
            bounds.push([note.lat, note.lng]);
          }
        });

        console.log("Added " + notes.length + " markers.");
        
        // Only fit bounds if explicitly requested (defults to true if undefined, but we pass false when navigating)
        if (shouldFitBounds !== false && bounds.length > 0) {
          console.log("Fitness bounds...");
          map.fitBounds(bounds, { padding: [50, 50] });
        } else {
            console.log("Skipping fitBounds (navigation active).");
        }
      } catch (e) {
        console.error("Error adding notes: " + e);
      }
    }
    
    // Function to fly to a specific location with zoom animation
    function flyToLocation(lat, lng, noteId, shouldOpenDetail) {
      try {
        console.log("Flying to: " + lat + ", " + lng + ", noteId: " + noteId + ", openDetail: " + shouldOpenDetail);
        
        map.flyTo([lat, lng], 18, {
          animate: true,
          duration: 2.0 
        });
        
        if (noteId) {
          setTimeout(function() {
            markersLayer.eachLayer(function(layer) {
              if (layer.noteId === noteId) {
                var markerElement = layer.getElement();
                if (markerElement) {
                  markerElement.style.animation = 'pulse 0.5s ease-in-out 3';
                }
              }
            });
            
            // Auto-open detail if requested
            if (shouldOpenDetail === true && window.javaConnector) {
                console.log("Auto-opening detail for note: " + noteId);
                window.javaConnector.openNoteDetail(noteId);
            }
            
          }, 2100); 
        }
      } catch (e) {
        console.error("Error flying: " + e);
      }
    }
  </script>
  
  <style>
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        transform: scale(1);
      }
    }
  </style>
</body>
</html>
